<!doctype html>
<html lang="en" class="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Interactive ODQA Explainer</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ["Inter", "sans-serif"],
                            mono: ["Fira Code", "monospace"],
                        },
                    },
                },
            };
        </script>
        <style>
            :root {
                --pattern-fg: rgba(0, 0, 0, 0.05);
            }
            html.dark {
                --pattern-fg: rgba(255, 255, 255, 0.1);
            }
            .pattern-bg {
                background-image: repeating-linear-gradient(
                    315deg,
                    var(--pattern-fg) 0,
                    var(--pattern-fg) 1px,
                    transparent 0,
                    transparent 50%
                );
                background-size: 10px 10px;
            }
            .highlight-border {
                border-color: #0ea5e9 !important; /* sky-500 */
                box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
            }
            .step-card {
                transition: all 0.5s ease-in-out;
                transform: translateY(20px);
                opacity: 0;
                visibility: hidden;
            }
            .step-card.active {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }
            .corpus-doc {
                width: 10px;
                height: 10px;
                background-color: #e2e8f0; /* slate-200 */
                border-radius: 2px;
                transition: all 0.3s ease;
            }
            .dark .corpus-doc {
                background-color: #334155; /* slate-700 */
            }
            .corpus-doc.highlighted {
                background-color: #38bdf8; /* sky-500 */
                transform: scale(1.5);
            }
            .dark .corpus-doc.highlighted {
                background-color: #0ea5e9; /* sky-600 */
            }
            .passage-card {
                transition: all 0.5s ease-in-out;
                opacity: 0;
                transform: scale(0.95);
            }
            .passage-card.visible {
                opacity: 1;
                transform: scale(1);
            }
            .answer-span {
                background-color: #fde047; /* yellow-300 */
                border-radius: 3px;
                padding: 0 2px;
                color: #422006; /* A darker text for yellow bg */
                font-weight: 600;
            }
            .loader {
                border: 4px solid #e5e7eb; /* gray-200 */
                border-top: 4px solid #3b82f6; /* blue-500 */
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
            }
            .dark .loader {
                border: 4px solid #374151; /* gray-700 */
                border-top: 4px solid #60a5fa; /* blue-400 */
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            .log-entry {
                animation: fadeIn 0.3s ease-in;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </head>
    <body
        class="bg-white dark:bg-gray-950 font-sans text-slate-700 dark:text-slate-300 antialiased"
    >
        <!-- Theme Toggle -->
        <div class="fixed top-4 right-4 z-50">
            <button
                id="theme-toggle"
                class="p-2 rounded-full bg-slate-200/50 dark:bg-slate-800/50 backdrop-blur-sm border border-slate-300/50 dark:border-slate-700/50 text-slate-600 dark:text-slate-300 hover:text-sky-500 dark:hover:text-sky-400"
            >
                <svg
                    id="theme-toggle-dark-icon"
                    class="w-5 h-5 hidden"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                >
                    <path
                        d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                    ></path>
                </svg>
                <svg
                    id="theme-toggle-light-icon"
                    class="w-5 h-5 hidden"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                >
                    <path
                        d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.464A1 1 0 106.465 13.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 11a1 1 0 100-2H4a1 1 0 100 2h1zM4.22 5.72a1 1 0 001.414-1.414L4.929 3.596a1 1 0 10-1.414 1.414l.707.707z"
                    ></path>
                </svg>
            </button>
        </div>

        <div
            class="relative grid min-h-screen grid-cols-[1fr_2.5rem_auto_2.5rem_1fr] grid-rows-[auto_2.5rem_1fr] bg-white dark:bg-gray-950"
        >
            <!-- Decorative Pattern Borders -->
            <div
                class="relative col-start-2 row-span-full row-start-2 border-x border-x-[--pattern-fg] pattern-bg"
            ></div>
            <div
                class="relative col-start-4 row-span-full row-start-2 border-x border-x-[--pattern-fg] pattern-bg"
            ></div>

            <!-- Main Content -->
            <div
                class="col-start-3 row-start-3 flex w-full max-w-4xl flex-col space-y-6 bg-gray-100 p-2 dark:bg-white/10"
            >
                <header
                    class="rounded-xl bg-white p-10 text-center text-gray-700 dark:bg-gray-950 dark:text-gray-300"
                >
                    <h1
                        class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white"
                    >
                        Open-Domain Question Answering
                    </h1>
                    <p class="mt-3 text-lg text-slate-600 dark:text-slate-400">
                        An interactive explainer based on
                        <a
                            href="https://lilianweng.github.io/posts/2020-10-29-odqa/"
                            target="_blank"
                            class="text-sky-500 dark:text-sky-400 hover:underline"
                            >Lilian Weng's article</a
                        >.
                    </p>
                </header>

                <!-- Step 1: Ask a Question -->
                <div
                    id="step1"
                    class="step-card active bg-white dark:bg-gray-950 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-800"
                >
                    <div class="flex items-center mb-4">
                        <svg
                            class="h-10 w-10 shrink-0 mr-4"
                            viewBox="0 0 40 40"
                            fill="none"
                        >
                            <circle
                                cx="20"
                                cy="20"
                                r="20"
                                class="fill-sky-400/25"
                            />
                            <text
                                x="50%"
                                y="50%"
                                dominant-baseline="middle"
                                text-anchor="middle"
                                class="font-bold text-xl fill-sky-800 dark:fill-sky-300"
                            >
                                1
                            </text>
                        </svg>
                        <h2
                            class="text-2xl font-semibold text-slate-900 dark:text-white"
                        >
                            Ask a Question
                        </h2>
                    </div>
                    <p class="mb-4">
                        Start by entering a question below, or select one of the
                        examples. The system will try to find the answer from a
                        large collection of documents.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            type="text"
                            id="questionInput"
                            class="flex-grow p-3 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-sky-400 focus:outline-none"
                            placeholder="e.g., What is the capital of Japan?"
                        />
                        <button
                            id="askButton"
                            class="bg-sky-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-sky-600 dark:bg-sky-600 dark:hover:bg-sky-500 transition-colors shadow-sm"
                        >
                            Ask
                        </button>
                    </div>
                    <div class="mt-4">
                        <p
                            class="text-sm text-slate-500 dark:text-slate-400 mb-2"
                        >
                            Or try an example:
                        </p>
                        <div
                            id="exampleQuestions"
                            class="flex flex-wrap gap-2"
                        ></div>
                    </div>
                </div>

                <!-- Step 2: The Retriever -->
                <div
                    id="step2"
                    class="step-card mt-0 bg-white dark:bg-gray-950 p-6 rounded-xl shadow-lg border-2 border-transparent transition-all duration-300"
                >
                    <div class="flex items-center mb-4">
                        <svg
                            class="h-10 w-10 shrink-0 mr-4"
                            viewBox="0 0 40 40"
                            fill="none"
                        >
                            <circle
                                cx="20"
                                cy="20"
                                r="20"
                                class="fill-sky-400/25"
                            />
                            <text
                                x="50%"
                                y="50%"
                                dominant-baseline="middle"
                                text-anchor="middle"
                                class="font-bold text-xl fill-sky-800 dark:fill-sky-300"
                            >
                                2
                            </text>
                        </svg>
                        <h2
                            class="text-2xl font-semibold text-slate-900 dark:text-white"
                        >
                            The Retriever
                        </h2>
                    </div>
                    <p class="mb-6">
                        First, the
                        <span
                            class="font-bold text-slate-800 dark:text-slate-100"
                            >Retriever</span
                        >
                        scans a massive knowledge base to find a small set of
                        passages that are most likely to contain the answer.
                    </p>
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="text-center">
                            <p
                                class="font-semibold mb-2 text-slate-800 dark:text-slate-100"
                            >
                                Your Question
                            </p>
                            <div
                                id="retrieverQuestion"
                                class="p-3 bg-sky-100 dark:bg-sky-950/50 border border-sky-200 dark:border-sky-800 rounded-lg text-sky-800 dark:text-sky-200 min-w-[200px]"
                            ></div>
                        </div>
                        <div class="text-center">
                            <div
                                id="retrieverLoader"
                                class="loader mx-auto my-4 hidden"
                            ></div>
                        </div>
                        <div class="text-center flex-grow">
                            <p
                                class="font-semibold mb-2 text-slate-800 dark:text-slate-100"
                            >
                                Knowledge Corpus
                            </p>
                            <div
                                id="corpusGrid"
                                class="grid grid-cols-10 gap-1 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 max-w-xs mx-auto"
                            ></div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: The Reader -->
                <div
                    id="step3"
                    class="step-card mt-0 bg-white dark:bg-gray-950 p-6 rounded-xl shadow-lg border-2 border-transparent transition-all duration-300"
                >
                    <div class="flex items-center mb-4">
                        <svg
                            class="h-10 w-10 shrink-0 mr-4"
                            viewBox="0 0 40 40"
                            fill="none"
                        >
                            <circle
                                cx="20"
                                cy="20"
                                r="20"
                                class="fill-sky-400/25"
                            />
                            <text
                                x="50%"
                                y="50%"
                                dominant-baseline="middle"
                                text-anchor="middle"
                                class="font-bold text-xl fill-sky-800 dark:fill-sky-300"
                            >
                                3
                            </text>
                        </svg>
                        <h2
                            class="text-2xl font-semibold text-slate-900 dark:text-white"
                        >
                            The Reader
                        </h2>
                    </div>
                    <p class="mb-6">
                        Next, the
                        <span
                            class="font-bold text-slate-800 dark:text-slate-100"
                            >Reader</span
                        >
                        model carefully examines each retrieved passage to
                        pinpoint the exact text span that answers the question.
                    </p>
                    <div id="passagesContainer" class="space-y-4"></div>
                </div>

                <!-- Step 4: Final Answer -->
                <div
                    id="step4"
                    class="step-card mt-0 bg-green-100/50 dark:bg-green-950/20 border-2 border-transparent p-6 rounded-xl shadow-lg"
                >
                    <div class="flex items-center mb-4">
                        <svg
                            class="h-10 w-10 shrink-0 mr-4"
                            viewBox="0 0 40 40"
                            fill="none"
                        >
                            <circle
                                cx="20"
                                cy="20"
                                r="20"
                                class="fill-green-400/25"
                            />
                            <path
                                d="M15 20.5L18.5 24L25 17"
                                class="stroke-green-800 dark:stroke-green-300"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
                        <h2
                            class="text-2xl font-semibold text-green-900 dark:text-green-200"
                        >
                            Final Answer
                        </h2>
                    </div>
                    <p
                        id="finalAnswerText"
                        class="text-3xl font-bold text-green-800 dark:text-green-300"
                    ></p>
                    <p class="text-slate-600 dark:text-slate-400 mt-2">
                        From passage:
                    </p>
                    <blockquote
                        id="finalAnswerSource"
                        class="mt-2 p-3 bg-white/70 dark:bg-slate-800/50 border-l-4 border-green-400 dark:border-green-500 text-slate-700 dark:text-slate-300 rounded-r-lg"
                    ></blockquote>
                    <div class="mt-6">
                        <button
                            id="resetButton"
                            class="bg-slate-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-slate-700 dark:bg-slate-700 dark:hover:bg-slate-600 transition-colors"
                        >
                            Ask New Question
                        </button>
                    </div>
                </div>

                <!-- Console Log -->
                <div
                    id="consoleContainer"
                    class="step-card mt-0 bg-gray-900 p-4 rounded-xl shadow-lg font-mono text-sm border border-gray-700 h-64 overflow-y-auto"
                >
                    <div
                        class="flex items-center border-b border-gray-700 pb-2 mb-2"
                    >
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <div
                                class="w-3 h-3 bg-yellow-500 rounded-full"
                            ></div>
                            <div
                                class="w-3 h-3 bg-green-500 rounded-full"
                            ></div>
                        </div>
                        <span class="ml-auto text-gray-400">System Log</span>
                    </div>
                    <div id="consoleLog" class="overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <script>
            // --- DATABASE ---
            const qaDatabase = {
                "What is the main component of Earth's atmosphere?": {
                    passages: [
                        {
                            text: "The Earth's atmosphere is a layer of gases surrounding the planet. By volume, dry air contains 78.09% nitrogen, 20.95% oxygen, and 0.93% argon.",
                            answer: "nitrogen",
                            score: 0.95,
                            isBest: true,
                        },
                        {
                            text: "Photosynthesis in plants uses carbon dioxide and releases oxygen, which is vital for respiration in animals.",
                            answer: "oxygen",
                            score: 0.65,
                            isBest: false,
                        },
                        {
                            text: "Mars has a very thin atmosphere, consisting of about 95% carbon dioxide, 3% nitrogen, and 1.6% argon.",
                            answer: null,
                            score: 0.02,
                            isBest: false,
                        },
                        {
                            text: "Nitrogen is a chemical element with the symbol N and atomic number 7. It is the most abundant element in Earth's atmosphere.",
                            answer: "Nitrogen",
                            score: 0.91,
                            isBest: false,
                        },
                    ],
                },
                "In what year was the first iPhone released?": {
                    passages: [
                        {
                            text: "The Android mobile operating system is based on a modified version of the Linux kernel. The first commercial Android device was launched in 2008.",
                            answer: "2008",
                            score: 0.45,
                            isBest: false,
                        },
                        {
                            text: "Steve Jobs, CEO of Apple, unveiled the first iPhone to the public on January 9, 2007. It went on sale in the United States on June 29, 2007.",
                            answer: "2007",
                            score: 0.98,
                            isBest: true,
                        },
                        {
                            text: "Apple Inc. was founded by Steve Jobs, Steve Wozniak, and Ronald Wayne in 1976 to develop and sell the Apple I personal computer.",
                            answer: null,
                            score: 0.05,
                            isBest: false,
                        },
                        {
                            text: "The popular iPhone 4 was released in 2010, introducing features like FaceTime and a high-resolution Retina Display.",
                            answer: "2010",
                            score: 0.3,
                            isBest: false,
                        },
                    ],
                },
                "Who painted the Mona Lisa?": {
                    passages: [
                        {
                            text: "The Mona Lisa is a half-length portrait painting by the Italian artist Leonardo da Vinci.",
                            answer: "Leonardo da Vinci",
                            score: 0.98,
                            isBest: true,
                        },
                        {
                            text: "Vincent van Gogh was a Dutch Post-Impressionist painter who is among the most famous and influential figures in the history of Western art.",
                            answer: "Vincent van Gogh",
                            score: 0.04,
                            isBest: false,
                        },
                        {
                            text: "The painting is housed in the Louvre Museum in Paris, France, and is a major tourist attraction.",
                            answer: null,
                            score: 0.12,
                            isBest: false,
                        },
                        {
                            text: "Leonardo's most famous works include the Vitruvian Man, The Last Supper, and the Mona Lisa.",
                            answer: "Leonardo",
                            score: 0.91,
                            isBest: false,
                        },
                    ],
                },
                "What is the capital of Japan?": {
                    passages: [
                        {
                            text: "Kyoto was the imperial capital of Japan for over a thousand years, but the seat of government was moved to Edo, now known as Tokyo.",
                            answer: "Tokyo",
                            score: 0.85,
                            isBest: false,
                        },
                        {
                            text: "Tokyo, officially the Tokyo Metropolis, is the capital and most populous prefecture of Japan.",
                            answer: "Tokyo",
                            score: 0.97,
                            isBest: true,
                        },
                        {
                            text: "Osaka is a large port city and commercial center on the Japanese island of Honshu. It is known for its modern architecture and nightlife.",
                            answer: null,
                            score: 0.03,
                            isBest: false,
                        },
                        {
                            text: "The capital of South Korea is Seoul, a huge metropolis where modern skyscrapers meet Buddhist temples.",
                            answer: "Seoul",
                            score: 0.01,
                            isBest: false,
                        },
                    ],
                },
                "When did the Titanic sink?": {
                    passages: [
                        {
                            text: "The RMS Titanic was a British passenger liner that sank in the North Atlantic Ocean on 15 April 1912.",
                            answer: "15 April 1912",
                            score: 0.99,
                            isBest: true,
                        },
                        {
                            text: "Construction of the Titanic began in 1909 in Belfast, Ireland. It was the largest ship afloat at the time of its maiden voyage.",
                            answer: "1909",
                            score: 0.21,
                            isBest: false,
                        },
                        {
                            text: "The wreck of the Titanic was discovered in 1985 by a team led by Robert Ballard.",
                            answer: "1985",
                            score: 0.15,
                            isBest: false,
                        },
                        {
                            text: "The movie 'Titanic', directed by James Cameron, was released in 1997 and became a massive box office success.",
                            answer: "1997",
                            score: 0.05,
                            isBest: false,
                        },
                    ],
                },
            };

            // --- DOM ELEMENTS ---
            const step1 = document.getElementById("step1"),
                step2 = document.getElementById("step2"),
                step3 = document.getElementById("step3"),
                step4 = document.getElementById("step4"),
                consoleContainer = document.getElementById("consoleContainer"),
                consoleLog = document.getElementById("consoleLog"),
                questionInput = document.getElementById("questionInput"),
                askButton = document.getElementById("askButton"),
                exampleQuestionsContainer =
                    document.getElementById("exampleQuestions"),
                resetButton = document.getElementById("resetButton"),
                retrieverQuestion =
                    document.getElementById("retrieverQuestion"),
                retrieverLoader = document.getElementById("retrieverLoader"),
                corpusGrid = document.getElementById("corpusGrid"),
                passagesContainer =
                    document.getElementById("passagesContainer"),
                finalAnswerText = document.getElementById("finalAnswerText"),
                finalAnswerSource =
                    document.getElementById("finalAnswerSource");
            let simulationTimeout;

            // --- THEME TOGGLE ---
            const themeToggle = document.getElementById("theme-toggle");
            const darkIcon = document.getElementById("theme-toggle-dark-icon");
            const lightIcon = document.getElementById(
                "theme-toggle-light-icon",
            );
            if (
                localStorage.getItem("color-theme") === "dark" ||
                (!("color-theme" in localStorage) &&
                    window.matchMedia("(prefers-color-scheme: dark)").matches)
            ) {
                document.documentElement.classList.add("dark");
                lightIcon.classList.remove("hidden");
            } else {
                document.documentElement.classList.remove("dark");
                darkIcon.classList.remove("hidden");
            }
            themeToggle.addEventListener("click", () => {
                darkIcon.classList.toggle("hidden");
                lightIcon.classList.toggle("hidden");
                if (localStorage.getItem("color-theme")) {
                    if (localStorage.getItem("color-theme") === "light") {
                        document.documentElement.classList.add("dark");
                        localStorage.setItem("color-theme", "dark");
                    } else {
                        document.documentElement.classList.remove("dark");
                        localStorage.setItem("color-theme", "light");
                    }
                } else {
                    if (document.documentElement.classList.contains("dark")) {
                        document.documentElement.classList.remove("dark");
                        localStorage.setItem("color-theme", "light");
                    } else {
                        document.documentElement.classList.add("dark");
                        localStorage.setItem("color-theme", "dark");
                    }
                }
            });

            // --- INITIALIZATION ---
            function initialize() {
                exampleQuestionsContainer.innerHTML = "";
                Object.keys(qaDatabase).forEach((q) => {
                    const btn = document.createElement("button");
                    btn.className =
                        "px-3 py-1 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-md text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors";
                    btn.textContent = q;
                    btn.onclick = () => {
                        questionInput.value = q;
                        startSimulation(q);
                    };
                    exampleQuestionsContainer.appendChild(btn);
                });
                corpusGrid.innerHTML = "";
                for (let i = 0; i < 100; i++) {
                    const doc = document.createElement("div");
                    doc.className = "corpus-doc";
                    doc.id = `doc-${i}`;
                    corpusGrid.appendChild(doc);
                }
                askButton.addEventListener("click", () => {
                    const q = questionInput.value.trim();
                    if (q && qaDatabase[q]) startSimulation(q);
                    else if (q)
                        showModal(
                            "Sorry, that question isn't in my small demo database. Please try one of the examples.",
                        );
                });
                questionInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") askButton.click();
                });
                resetButton.addEventListener("click", () => {
                    clearTimeout(simulationTimeout);
                    resetSimulation();
                });
            }

            // --- HELPER FUNCTIONS ---
            function highlightBox(box, duration = 2000) {
                if (box) {
                    box.classList.add("highlight-border");
                    setTimeout(
                        () => box.classList.remove("highlight-border"),
                        duration,
                    );
                }
            }

            function logToConsole(message, type = "info") {
                const entry = document.createElement("div");
                entry.className = "log-entry mb-1 flex";
                const typeMap = {
                    success: ["[SUCCESS]", "text-green-400"],
                    warn: ["[WARN]   ", "text-yellow-400"],
                    process: ["[PROCESS]", "text-sky-400"],
                    info: ["[INFO]   ", "text-slate-400"],
                };
                const [prefix, colorClass] = typeMap[type] || typeMap.info;
                entry.innerHTML = `<span class="text-gray-500 mr-3 flex-shrink-0">${prefix}</span> <span class="${colorClass}">${message}</span>`;
                consoleLog.appendChild(entry);
                consoleLog.scrollTop = consoleLog.scrollHeight;
            }

            // --- SIMULATION LOGIC ---
            function startSimulation(question) {
                clearTimeout(simulationTimeout);
                resetSimulation(true);
                questionInput.disabled = true;
                askButton.disabled = true;
                exampleQuestionsContainer.style.pointerEvents = "none";
                exampleQuestionsContainer.style.opacity = "0.5";
                consoleContainer.classList.add("active");
                logToConsole(`Received question: "${question}"`);
                retrieverQuestion.textContent = question;
                step2.classList.add("active");
                simulationTimeout = setTimeout(
                    () => runRetriever(question),
                    500,
                );
            }

            function runRetriever(question) {
                logToConsole(
                    "Retriever activated. Searching corpus...",
                    "process",
                );
                highlightBox(step2);
                retrieverLoader.style.display = "block";
                simulationTimeout = setTimeout(() => {
                    retrieverLoader.style.display = "none";
                    const docElements = Array.from(
                        document.querySelectorAll(".corpus-doc"),
                    );
                    const relevantIndices = new Set();
                    while (relevantIndices.size < 4)
                        relevantIndices.add(
                            Math.floor(Math.random() * docElements.length),
                        );
                    relevantIndices.forEach((i) =>
                        docElements[i].classList.add("highlighted"),
                    );
                    logToConsole(
                        "Retriever found 4 potentially relevant passages.",
                        "success",
                    );
                    simulationTimeout = setTimeout(
                        () => runReader(question),
                        1000,
                    );
                }, 1500);
            }

            function runReader(question) {
                logToConsole(
                    "Reader activated. Analyzing passages...",
                    "process",
                );
                step3.classList.add("active");
                highlightBox(step3);
                const data = qaDatabase[question];
                data.passages.forEach((passage, index) => {
                    simulationTimeout = setTimeout(() => {
                        const passageCard = createPassageCard(passage);
                        passagesContainer.appendChild(passageCard);
                        setTimeout(
                            () => passageCard.classList.add("visible"),
                            50,
                        );
                        logToConsole(
                            `Analyzing passage #${index + 1}. Score: ${(passage.score * 100).toFixed(0)}%`,
                        );
                    }, index * 800);
                });
                const totalReaderTime = data.passages.length * 800;
                simulationTimeout = setTimeout(
                    () => showFinalAnswer(question),
                    totalReaderTime + 500,
                );
            }

            function createPassageCard(passageData) {
                const card = document.createElement("div");
                card.className =
                    "passage-card bg-slate-100/70 dark:bg-slate-800/70 p-4 rounded-lg border border-slate-200 dark:border-slate-700";
                let highlightedText = passageData.text;
                if (passageData.answer)
                    highlightedText = passageData.text.replace(
                        new RegExp(`(${passageData.answer})`, "ig"),
                        `<span class="answer-span">$1</span>`,
                    );
                const scoreColor =
                    passageData.score > 0.9
                        ? "text-green-600 dark:text-green-400"
                        : passageData.score > 0.5
                          ? "text-yellow-600 dark:text-yellow-400"
                          : "text-red-600 dark:text-red-400";
                const scoreText = passageData.answer
                    ? `Confidence Score: ${(passageData.score * 100).toFixed(0)}%`
                    : "No answer found";
                card.innerHTML = `<p>${highlightedText}</p><div class="text-right text-sm font-medium mt-2 ${scoreColor}">${scoreText}</div>`;
                return card;
            }

            function showFinalAnswer(question) {
                const bestPassage = qaDatabase[question].passages.find(
                    (p) => p.isBest,
                );
                logToConsole(
                    `Highest scoring answer found: "${bestPassage.answer}"`,
                    "success",
                );
                logToConsole("Simulation complete. Ready for new question.");
                step4.classList.add("active");
                highlightBox(step4, 3000);
                finalAnswerText.textContent = bestPassage.answer;
                finalAnswerSource.innerHTML = bestPassage.text.replace(
                    new RegExp(`(${bestPassage.answer})`, "i"),
                    `<strong class="text-green-800 dark:text-green-300">$1</strong>`,
                );
            }

            function resetSimulation(isSoft = false) {
                if (!isSoft) {
                    questionInput.value = "";
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }
                questionInput.disabled = false;
                askButton.disabled = false;
                exampleQuestionsContainer.style.pointerEvents = "auto";
                exampleQuestionsContainer.style.opacity = "1";
                [step2, step3, step4, consoleContainer].forEach((el) =>
                    el.classList.remove("active"),
                );
                passagesContainer.innerHTML = "";
                consoleLog.innerHTML = "";
                corpusGrid
                    .querySelectorAll(".corpus-doc")
                    .forEach((doc) => doc.classList.remove("highlighted"));
            }

            function showModal(message) {
                const modalBackdrop = document.createElement("div");
                modalBackdrop.className =
                    "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
                modalBackdrop.innerHTML = `<div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p class="text-slate-700 dark:text-slate-300 mb-4">${message}</p><button class="w-full bg-sky-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-600">OK</button></div>`;
                document.body.appendChild(modalBackdrop);
                modalBackdrop.querySelector("button").onclick = () =>
                    document.body.removeChild(modalBackdrop);
            }

            // --- START ---
            document.addEventListener("DOMContentLoaded", initialize);
        </script>
    </body>
</html>
